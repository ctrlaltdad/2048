<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2048 Python Web</title>
    <style>
        body { font-family: Arial, sans-serif; background: #faf8ef; color: #776e65; }
        #board { 
            display: grid; 
            grid-template-columns: repeat(4, 80px); 
            grid-gap: 8px; 
            margin: 30px auto; 
            width: 352px;
        }
        .tile { 
            width: 80px; 
            height: 80px; 
            background: #cdc1b4; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 2em; 
            font-weight: bold; 
            border-radius: 4px; 
        }
        .tile-0 { background: #cdc1b4; color: #cdc1b4; }
        .tile-2 { background: #eee4da; color: #776e65; }
        .tile-4 { background: #ede0c8; color: #776e65; }
        .tile-8 { background: #f2b179; color: #f9f6f2; }
        .tile-16 { background: #f59563; color: #f9f6f2; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; }
        .tile-128 { background: #edcf72; color: #f9f6f2; }
        .tile-256 { background: #edcc61; color: #f9f6f2; }
        .tile-512 { background: #edc850; color: #f9f6f2; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; }
        #controls { text-align: center; margin: 20px; }
        button { margin: 0 5px; padding: 10px 20px; font-size: 1em; }
        #analysis { margin: 20px auto; width: 352px; }
        #log { font-size: 0.9em; color: #888; }
    </style>
</head>
<body>
    <h1 style="text-align:center;">2048 Python Web</h1>
    <div id="controls">
        <button id="btn-play" onclick="setMode('play')">Play</button>
        <button id="btn-heuristic" onclick="setMode('heuristic')">Emulate Heuristic</button>
        <button id="btn-analysis" onclick="setMode('analysis')">Run Analysis</button>
        <select id="heuristicSelect" onchange="updateDescription()">
            <option value="monotonicity">Monotonicity</option>
            <option value="corner">Corner</option>
            <option value="center">Center</option>
            <option value="expectimax">Expectimax</option>
            <option value="opportunistic">Opportunistic</option>
            <option value="smoothness">Smoothness</option>
            <option value="adaptive">Adaptive</option>
            <option value="ultraAdaptive">Ultra-Adaptive</option>
            <option value="advancedMinimax">Advanced Minimax</option>
            <option value="weighted">Weighted</option>
        </select>
        <label style="margin-left:10px;"><input type="checkbox" id="twophase" onchange="updateDescription()"> Two-Phase</label>
        <button id="btn-reset" onclick="resetGame()">Reset</button>
    </div>
    <div style="display: flex; justify-content: center; align-items: flex-start;">
        <div style="min-width: 400px;">
            <div id="board"></div>
            <div id="analysis"></div>
            <div id="log"></div>
        </div>
        <div id="sidepane" style="margin-left: 32px; width: 340px; background: #f7f7f7; border-radius: 8px; box-shadow: 0 2px 8px #ccc; min-height: 400px;">
            <div style="display: flex; border-bottom: 1px solid #ddd;">
                <button id="tab-desc" onclick="showTab('desc')" style="flex:1; padding:10px; border:none; background:#eee; font-weight:bold; transition: font-weight 0.2s;">Description</button>
                <button id="tab-stats" onclick="showTab('stats')" style="flex:1; padding:10px; border:none; background:#f7f7f7; font-weight:normal; transition: font-weight 0.2s;">Statistics</button>
            </div>
            <div id="tab-content-desc" style="padding: 16px;">
                <b>Mode:</b> <span id="desc-mode">Play</span><br><br>
                <b>Heuristic:</b> <span id="desc-heuristic">N/A</span><br><br>
                <div id="desc-details">Use arrow keys or WASD to play manually. Select a mode above.</div>
            </div>
            <div id="tab-content-stats" style="display:none; padding: 16px;">
                <div id="stats-content">No statistics yet.</div>
            </div>
        </div>
    </div>

    <script>
        // --- Minimal 2048 logic in JS for browser play ---
        let board, score, mode = 'play', interval = null;
        .weight-control input {
            width: 80px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .button-primary {
            background: #776e65;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
        }
        .button-primary:hover {
            background: #665c57;
        }
        .nav-button {
            background: #8f7a66;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .nav-button:hover {
            background: #776e65;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .dropdown-item {
            color: #776e65;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border: none;
            width: 100%;
            text-align: left;
            background: none;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            color: #776e65;
        }
        select:focus {
            outline: none;
            border-color: #776e65;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #776e65;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Disabled states */
        button:disabled,
        select:disabled,
        input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-button:disabled {
            background: #ccc;
            pointer-events: none;
        }
        
        .dropdown-item:disabled {
            color: #ccc;
            background: #f9f9f9;
            cursor: not-allowed;
        }
        
        .weight-control input:disabled {
            background: #f5f5f5;
            border-color: #ddd;
        }
        
        .button-primary:disabled {
            background: #ccc;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">2048 Python Web</h1>
    <div class="nav-bar" style="background: #776e65; padding: 10px 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; gap: 10px;">
                <button id="btn-play" class="nav-button">Play</button>
                <button id="btn-heuristic" class="nav-button">Emulate Heuristic</button>
                <button id="btn-analysis" class="nav-button">Run Analysis</button>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <select id="heuristicSelect" onchange="updateDescription()" style="padding: 6px; border-radius: 4px; border: none;">
                    <option value="monotonicity">Monotonicity</option>
                    <option value="corner">Corner</option>
                    <option value="center">Center</option>
                    <option value="expectimax">Expectimax</option>
                    <option value="opportunistic">Opportunistic</option>
                    <option value="smoothness">Smoothness</option>
                    <option value="adaptive">Adaptive</option>
                    <option value="ultraAdaptive">Ultra-Adaptive</option>
                    <option value="advancedMinimax">Advanced Minimax</option>
                    <option value="weighted">Weighted Combo</option>
                </select>
                <label style="color: white;"><input type="checkbox" id="twophase" onchange="updateDescription()"> Two-Phase</label>
                <button id="btn-reset" class="nav-button">Reset</button>
                <div class="dropdown">
                    <button class="nav-button">Export â–¼</button>
                    <div class="dropdown-content">
                        <button class="dropdown-item" onclick="exportResults('csv')">Export CSV</button>
                        <button class="dropdown-item" onclick="exportResults('html')">Export HTML</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="display: flex; justify-content: center; align-items: flex-start;">
        <div style="min-width: 400px;">
            <div id="board"></div>
            <div id="analysis"></div>
            <div id="log"></div>
        </div>
        <div id="sidepane" style="margin-left: 32px; width: 340px; background: #f7f7f7; border-radius: 8px; box-shadow: 0 2px 8px #ccc; min-height: 400px;">
            <div style="display: flex; border-bottom: 1px solid #ddd;">
                <button id="tab-desc" onclick="showTab('desc')" style="flex:1; padding:10px; border:none; background:#eee; font-weight:bold; transition: font-weight 0.2s;">Description</button>
                <button id="tab-stats" onclick="showTab('stats')" style="flex:1; padding:10px; border:none; background:#f7f7f7; font-weight:normal; transition: font-weight 0.2s;">Statistics</button>
                <button id="tab-settings" onclick="showTab('settings')" style="flex:1; padding:10px; border:none; background:#f7f7f7; font-weight:normal; transition: font-weight 0.2s;">Settings</button>
            </div>
            <div id="tab-content-desc" style="padding: 16px;">
                <b>Mode:</b> <span id="desc-mode">Play</span><br><br>
                <b>Heuristic:</b> <span id="desc-heuristic">N/A</span><br><br>
                <div id="desc-details">Use arrow keys or WASD to play manually. Select a mode above.</div>
            </div>
            <div id="tab-content-stats" style="display:none; padding: 16px;">
                <div id="stats-content">No statistics yet.</div>
            </div>
            <div id="tab-content-settings" style="display:none; padding: 16px;">
                <div class="settings-panel">
                    <h3>Analysis Settings</h3>
                    <div class="settings-group">
                        <h3>Run Configuration</h3>
                        <div class="weight-control">
                            <label for="runCount">Number of Runs:</label>
                            <input type="number" id="runCount" value="20" min="1" max="1000">
                        </div>
                        <div class="weight-control">
                            <label for="pauseDuration">Emulation Speed (seconds):</label>
                            <input type="number" id="pauseDuration" value="0.5" step="0.1" min="0.1" max="5">
                        </div>
                    </div>
                    <div class="settings-group" id="weightControls">
                        <h3>Strategy Weights</h3>
                        <div class="weight-control">
                            <label for="weightMonotonicity">Monotonicity Weight:</label>
                            <input type="number" id="weightMonotonicity" value="1.0" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightCorner">Corner Weight:</label>
                            <input type="number" id="weightCorner" value="0.0" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightCenter">Center Weight:</label>
                            <input type="number" id="weightCenter" value="0.0" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightExpectimax">Expectimax Weight:</label>
                            <input type="number" id="weightExpectimax" value="0.0" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightOpportunistic">Opportunistic Weight:</label>
                            <input type="number" id="weightOpportunistic" value="0.0" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightSmoothness">Smoothness Weight:</label>
                            <input type="number" id="weightSmoothness" value="0.1" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightEmpty">Empty Tiles Weight:</label>
                            <input type="number" id="weightEmpty" value="2.7" step="0.1" min="0" max="5">
                        </div>
                        <div class="weight-control">
                            <label for="weightMerge">Merge Weight:</label>
                            <input type="number" id="weightMerge" value="1.0" step="0.1" min="0" max="5">
                        </div>
                    </div>
                    <button class="button-primary" onclick="applySettings()">Apply Settings</button>
                </div>
                <!-- Add ML Optimization section to the settings panel -->
                <div class="settings-group" id="mlOptimization">
                    <h3>ML Weight Optimization</h3>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 10px; border-left: 3px solid #ffc107;">
                        <small><strong>Experimental:</strong> Use machine learning to find optimal weights automatically.</small>
                    </div>
                    
                    <div class="weight-control">
                        <label for="optimizationMethod">Optimization Method:</label>
                        <select id="optimizationMethod" style="width: 120px;">
                            <option value="random">Random Search</option>
                            <option value="genetic">Genetic Algorithm</option>
                            <option value="grid">Grid Search</option>
                            <option value="bayesian">Bayesian Opt</option>
                        </select>
                    </div>
                    
                    <div class="weight-control">
                        <label for="optimizationIterations">Iterations/Generations:</label>
                        <input type="number" id="optimizationIterations" value="20" min="5" max="100">
                    </div>
                    
                    <div class="weight-control">
                        <label for="gamesPerEvaluation">Games per Evaluation:</label>
                        <input type="number" id="gamesPerEvaluation" value="10" min="5" max="50">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="button-primary" onclick="startOptimization()" id="btnStartOptimization">
                            Start Optimization
                        </button>
                        <button class="nav-button" onclick="stopOptimization()" id="btnStopOptimization" disabled>
                            Stop
                        </button>
                    </div>
                    
                    <div id="optimizationProgress" style="margin-top: 10px; display: none;">
                        <div style="background: #e9ecef; border-radius: 4px; height: 20px; margin: 5px 0;">
                            <div id="optimizationProgressBar" style="background: #28a745; width: 0%; height: 100%; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                        <div id="optimizationStatus" style="font-size: 0.9em; color: #666;">
                            Initializing...
                        </div>
                    </div>
                    
                    <div id="optimizationResults" style="margin-top: 10px; display: none;">
                        <h4>Best Configuration Found:</h4>
                        <div id="bestWeights" style="font-family: monospace; font-size: 0.8em; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                        </div>
                        <div id="bestPerformance" style="margin-top: 5px; font-weight: bold;">
                        </div>
                        <button class="nav-button" onclick="applyOptimizedWeights()" style="margin-top: 8px;">
                            Apply These Weights
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // --- Global variables ---
        let board, score, mode = 'play', interval = null;
        
        // --- Update description pane (defined early to avoid reference errors) ---
        function updateDescription() {
            let modeMap = {play:'Manual Play', heuristic:'Heuristic Emulation', analysis:'Analysis'};
            let heurMap = {
                monotonicity: 'Monotonicity: Favors boards where rows/columns are strictly increasing or decreasing.',
                corner: 'Corner: Tries to keep the largest tile in a corner.',
                center: 'Center: Favors moves toward the center.',
                expectimax: 'Expectimax: Looks ahead using expected value.',
                opportunistic: 'Opportunistic: Combines tiles whenever possible.',
                smoothness: 'Smoothness: Prefers boards where neighboring tiles have similar values.',
                adaptive: 'Adaptive: Changes strategy based on game phase (early/mid/late game).',
                ultraAdaptive: 'Ultra-Adaptive: Advanced phase detection with minimax integration.',
                advancedMinimax: 'Advanced Minimax: Deep lookahead with alpha-beta pruning and snake patterns.',
                weighted: 'Weighted Combo: Combines multiple strategies with weights.'
            };
            
            try {
                let twophase = document.getElementById('twophase') ? document.getElementById('twophase').checked : false;
                let heur = document.getElementById('heuristicSelect') ? document.getElementById('heuristicSelect').value : 'monotonicity';
                let heurDesc = (twophase? 'Two-Phase '+heur : heur);
                
                const modeElement = document.getElementById('desc-mode');
                const heuristicElement = document.getElementById('desc-heuristic');
                const detailsElement = document.getElementById('desc-details');
                
                if (modeElement) modeElement.innerText = modeMap[mode] || mode;
                if (heuristicElement) heuristicElement.innerText = (mode==='heuristic'||mode==='analysis') ? heurDesc : 'N/A';
                if (detailsElement) detailsElement.innerText = (mode==='play') ?
                    'Use arrow keys or WASD to play manually.' :
                    (twophase? 'Two-phase: monotonicity, then selected heuristic.' : (heurMap[heur] || ''));
            } catch (error) {
                console.log('Error in updateDescription:', error);
            }
        }
        
        // Make updateDescription globally accessible immediately
        window.updateDescription = updateDescription;
        
        // --- Mode switching and initialization ---
        function setMode(m) {
            mode = m;
            clearInterval(interval);
            document.getElementById('analysis').innerHTML = '';
            if(mode==='heuristic') {
                startHeuristicEmulation();
            }
            if(mode==='analysis') {
                runAnalysis();
            }
            drawBoard();
            updateDescription();
            if(mode!=='analysis') updateStats('No statistics yet.');
        }
        
        // --- Minimal 2048 logic in JS for browser play ---
        function emptyBoard() {
            board = Array.from({length:4},()=>Array(4).fill(0));
            score = 0;
            addTile(); addTile();
        }
        function addTile() {
            let empty = [];
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) if(board[i][j]===0) empty.push([i,j]);
            if(empty.length===0) return;
            let [i,j] = empty[Math.floor(Math.random()*empty.length)];
            board[i][j] = Math.random()<0.1?4:2;
        }
        function drawBoard() {
            let html = '';
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) {
                let v = board[i][j];
                // Always create a tile div, even for empty cells (value 0)
                html += `<div class="tile ${v ? 'tile-' + v : 'tile-0'}">${v || ''}</div>`;
            }
            document.getElementById('board').innerHTML = html;
            
            // Add real-time stats
            let maxTile = Math.max(...board.flat());
            let emptyCount = board.flat().filter(x=>x===0).length;
            let statsHtml = `
                <div class="real-time-stats">
                    Score: ${score} | Max Tile: ${maxTile} | Empty: ${emptyCount}
                    ${mode === 'heuristic' ? '<br>Strategy: ' + document.getElementById('heuristicSelect').value : ''}
                </div>`;
            
            // Add heatmap showing tile frequency
            if(window._tileHistory === undefined) window._tileHistory = Array(16).fill(0);
            let pos = 0;
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) {
                if(board[i][j] > 0) window._tileHistory[pos]++;
                pos++;
            }
            
            let maxFreq = Math.max(...window._tileHistory);
            let heatmapHtml = '<div class="heatmap">';
            pos = 0;
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) {
                let intensity = maxFreq ? window._tileHistory[pos]/maxFreq : 0;
                let bgcolor = `rgba(242,177,121,${intensity})`;
                heatmapHtml += `
                    <div class="heatmap-cell" style="background:${bgcolor}">
                        ${Math.round(intensity*100)}%
                    </div>`;
                pos++;
            }
            heatmapHtml += '</div>';
            
            document.getElementById('log').innerHTML = statsHtml + heatmapHtml;
        }
        function move(dir) {
            let moved = false;
            let old = board.map(r=>r.slice());
            if(dir==='left'||dir==='right') {
                for(let n=0;n<4;n++) {
                    let arr = board[n].slice();
                    if(dir==='right') arr = arr.reverse();
                    let filtered = arr.filter(x=>x);
                    for(let i=0;i<filtered.length-1;i++) if(filtered[i]===filtered[i+1]) { filtered[i]*=2; score+=filtered[i]; filtered[i+1]=0; }
                    filtered = filtered.filter(x=>x);
                    while(filtered.length<4) filtered.push(0);
                    if(dir==='right') filtered = filtered.reverse();
                    board[n] = filtered;
                }
            } else if(dir==='up'||dir==='down') {
                // Transpose, operate as left/right, then transpose back
                let t = [0,1,2,3].map(i=>[board[0][i],board[1][i],board[2][i],board[3][i]]);
                for(let n=0;n<4;n++) {
                    let arr = t[n].slice();
                    if(dir==='down') arr = arr.reverse();
                    let filtered = arr.filter(x=>x);
                    for(let i=0;i<filtered.length-1;i++) if(filtered[i]===filtered[i+1]) { filtered[i]*=2; score+=filtered[i]; filtered[i+1]=0; }
                    filtered = filtered.filter(x=>x);
                    while(filtered.length<4) filtered.push(0);
                    if(dir==='down') filtered = filtered.reverse();
                    t[n] = filtered;
                }
                // Transpose back
                for(let i=0;i<4;i++) for(let j=0;j<4;j++) board[i][j]=t[j][i];
            }
            moved = JSON.stringify(old)!==JSON.stringify(board);
            if(moved) addTile();
            drawBoard();
            if(isGameOver()) document.getElementById('log').innerText += ' | Game Over!';
            return moved;
        }
        function isGameOver() {
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) if(board[i][j]===0) return false;
            for(let i=0;i<4;i++) for(let j=0;j<3;j++) if(board[i][j]===board[i][j+1]) return false;
            for(let j=0;j<4;j++) for(let i=0;i<3;i++) if(board[i][j]===board[i+1][j]) return false;
            return true;
        }
        // Fix: Only attach one keydown event, and always draw board after mode change
        let keyHandler = function(e) {
            if(mode!=='play') return;
            let key = e.key.toLowerCase();
            if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d'].includes(key)) {
                e.preventDefault();
                if(key==='arrowup'||key==='w') move('up');
                if(key==='arrowdown'||key==='s') move('down');
                if(key==='arrowleft'||key==='a') move('left');
                if(key==='arrowright'||key==='d') move('right');
            }
        };
        window.removeEventListener('keydown', keyHandler); // Remove if already attached
        window.addEventListener('keydown', keyHandler);
        // --- Tab switching with highlight ---
        function showTab(tab) {
            document.getElementById('tab-content-desc').style.display = (tab==='desc') ? '' : 'none';
            document.getElementById('tab-content-stats').style.display = (tab==='stats') ? '' : 'none';
            document.getElementById('tab-content-settings').style.display = (tab==='settings') ? '' : 'none';
            
            document.getElementById('tab-desc').style.background = (tab==='desc') ? '#eee' : '#f7f7f7';
            document.getElementById('tab-stats').style.background = (tab==='stats') ? '#eee' : '#f7f7f7';
            document.getElementById('tab-settings').style.background = (tab==='settings') ? '#eee' : '#f7f7f7';
            
            document.getElementById('tab-desc').style.fontWeight = (tab==='desc') ? 'bold' : 'normal';
            document.getElementById('tab-stats').style.fontWeight = (tab==='stats') ? 'bold' : 'normal';
            document.getElementById('tab-settings').style.fontWeight = (tab==='settings') ? 'bold' : 'normal';
        }

        // Settings management
        let gameSettings = {
            runs: 20,
            pauseDuration: 0.5, // Default pause duration in seconds
            weights: {
                monotonicity: 1.0,
                corner: 0.0,
                center: 0.0,
                expectimax: 0.0,
                opportunistic: 0.0,
                smoothness: 0.1,
                empty: 2.7,
                merge: 1.0
            }
        };

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Show the toast
            setTimeout(() => {
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                    document.body.removeChild(toast);
                }, 3000);
            }, 100);
        }

        // Update applySettings to use toast
        function applySettings() {
            gameSettings.runs = parseInt(document.getElementById('runCount').value) || 20;
            gameSettings.pauseDuration = parseFloat(document.getElementById('pauseDuration').value) || 0.5;
            gameSettings.weights = {
                monotonicity: parseFloat(document.getElementById('weightMonotonicity').value) || 1.0,
                corner: parseFloat(document.getElementById('weightCorner').value) || 0.0,
                center: parseFloat(document.getElementById('weightCenter').value) || 0.0,
                expectimax: parseFloat(document.getElementById('weightExpectimax').value) || 0.0,
                opportunistic: parseFloat(document.getElementById('weightOpportunistic').value) || 0.0,
                smoothness: parseFloat(document.getElementById('weightSmoothness').value) || 0.1,
                empty: parseFloat(document.getElementById('weightEmpty').value) || 2.7,
                merge: parseFloat(document.getElementById('weightMerge').value) || 1.0
            };
            
            // Update emulation speed if currently running
            if(interval) {
                clearInterval(interval);
                startHeuristicEmulation();
            }
            
            showToast('Settings applied successfully!');
        }

        // Update evalWeightedStrategy to use custom weights
        function evalWeightedStrategy(b) {
            let totalScore = 0;
            let weights = gameSettings.weights;
            
            // Only calculate scores for heuristics with weight > 0 (efficiency)
            if (weights.monotonicity > 0) {
                totalScore += evalMonotonicity(b) * weights.monotonicity;
            }
            
            if (weights.corner > 0) {
                totalScore += evalCorner(b) * weights.corner;
            }
            
            if (weights.center > 0) {
                totalScore += evalCenter(b) * weights.center;
            }
            
            if (weights.expectimax > 0) {
                totalScore += evalExpectimax(b) * weights.expectimax;
            }
            
            if (weights.opportunistic > 0) {
                totalScore += evalOpportunistic(b) * weights.opportunistic;
            }
            
            if (weights.smoothness > 0) {
                totalScore += evalSmoothness(b) * weights.smoothness;
            }
            
            if (weights.empty > 0) {
                let emptyScore = b.flat().filter(x=>x===0).length * 100;
                totalScore += emptyScore * weights.empty;
            }
            
            if (weights.merge > 0) {
                let mergeScore = 0;
                for(let i=0; i<4; i++) {
                    for(let j=0; j<3; j++) {
                        if(b[i][j] && b[i][j]===b[i][j+1]) mergeScore += b[i][j];
                        if(b[j][i] && b[j][i]===b[j+1][i]) mergeScore += b[j][i];
                    }
                }
                totalScore += mergeScore * weights.merge;
            }
            
            return totalScore;
        }

        // Helper functions for analysis UI
        function getAnalysisParamSummary(heuristic, twophase) {
            return `
                <div style="background:#f0f0f0; padding:12px; border-radius:6px; margin:10px 0; border-left:4px solid #776e65">
                    <div style="font-size:1.1em; margin-bottom:8px;"><b>Analysis Parameters</b></div>
                    <div><b>Strategy:</b> ${heuristic}</div>
                    <div><b>Two-Phase Mode:</b> ${twophase ? "Enabled" : "Disabled"}</div>
                </div>
            `;
        }

        function updateProgressBar(current, total) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            return `
                <div style="background:#eee; border-radius:10px; padding:3px; margin:10px 0;">
                    <div style="background:#776e65; height:20px; width:${percentage}%; border-radius:8px; transition:width 0.3s;"></div>
                </div>
                <div style="text-align:center; font-size:0.9em; color:#776e65;">
                    Progress: ${current}/${total} (${percentage}%)
                </div>
            `;
        }

        function resetGame() {
            emptyBoard();
            drawBoard();
        }

        function moveBoard(direction) {
            return move(direction);
        }

        function drawDistChart(distribution) {
            // Simple chart drawing function for analysis results
            try {
                const canvas = document.getElementById('distChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const keys = Object.keys(distribution).sort((a, b) => parseInt(a) - parseInt(b));
                const maxCount = Math.max(...Object.values(distribution));
                const barWidth = canvas.width / keys.length;
                
                keys.forEach((key, index) => {
                    const count = distribution[key];
                    const barHeight = (count / maxCount) * (canvas.height - 20);
                    
                    ctx.fillStyle = '#776e65';
                    ctx.fillRect(index * barWidth, canvas.height - barHeight, barWidth - 2, barHeight);
                    
                    ctx.fillStyle = '#444';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(key, index * barWidth + barWidth/2, canvas.height - 5);
                });
            } catch (error) {
                console.log('Chart drawing error:', error);
            }
        }

        // Essential missing functions
        function runAnalysis() {
            showToast('Analysis functionality is being restored...');
        }

        function evalMonotonicity(b) {
            let score = 0;
            for(let i = 0; i < 4; i++) {
                let row = b[i];
                let increasing = true, decreasing = true;
                for(let j = 0; j < 3; j++) {
                    if(row[j] !== 0 && row[j+1] !== 0) {
                        if(row[j] > row[j+1]) increasing = false;
                        if(row[j] < row[j+1]) decreasing = false;
                    }
                }
                if(increasing || decreasing) score += 100;
            }
            return score;
        }

        function pickHeuristicMove(heuristic) {
            let moves = ['up', 'down', 'left', 'right'];
            let bestMove = 'up';
            let bestScore = -Infinity;
            
            for (let move of moves) {
                let testBoard = board.map(row => row.slice());
                let oldBoard = JSON.stringify(testBoard);
                
                // Apply move logic (simplified)
                if (move === 'left' || move === 'right') {
                    for (let n = 0; n < 4; n++) {
                        let arr = testBoard[n].slice();
                        if (move === 'right') arr = arr.reverse();
                        let filtered = arr.filter(x => x);
                        for (let i = 0; i < filtered.length - 1; i++) {
                            if (filtered[i] === filtered[i + 1]) {
                                filtered[i] *= 2;
                                filtered[i + 1] = 0;
                            }
                        }
                        filtered = filtered.filter(x => x);
                        while (filtered.length < 4) filtered.push(0);
                        if (move === 'right') filtered = filtered.reverse();
                        testBoard[n] = filtered;
                    }
                }
                
                if (JSON.stringify(testBoard) !== oldBoard) {
                    let moveScore = evalMonotonicity(testBoard);
                    if (moveScore > bestScore) {
                        bestScore = moveScore;
                        bestMove = move;
                    }
                }
            }
            return bestMove;
        }

        function startHeuristicEmulation() {
            if(interval) clearInterval(interval);
            interval = setInterval(() => {
                let move = pickHeuristicMove('monotonicity');
                if(move && !isGameOver()) {
                    moveBoard(move);
                    drawBoard();
                } else {
                    clearInterval(interval);
                    resetGame();
                }
            }, 500);
        }

        function initializeGame() {
            emptyBoard(); 
            drawBoard();
            try {
                document.getElementById('btn-play').addEventListener('click', () => setMode('play'));
                document.getElementById('btn-heuristic').addEventListener('click', () => setMode('heuristic'));
                document.getElementById('btn-analysis').addEventListener('click', () => setMode('analysis'));
            } catch(e) {
                console.log('Some UI elements not found:', e);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }
    </script>

    <!-- HTML body structure -->
    <div id="board"></div>
    <div id="controls">
        <button id="btn-play">Manual Play</button>
        <button id="btn-heuristic">Auto Play</button>
        <button id="btn-analysis">Analysis</button>
        <button onclick="resetGame()">Reset</button>
    </div>
    <div id="log"></div>
    <div id="analysis"></div>

    <script>
        // Add missing game settings structure
        if (!window.gameSettings) {
            window.gameSettings = {
                runs: 20,
                pauseDuration: 0.5,
                weights: {
                    monotonicity: 1.0,
                    corner: 0.0,
                    center: 0.0,
                    expectimax: 0.0,
                    opportunistic: 0.0,
                    smoothness: 0.1,
                    empty: 2.7,
                    merge: 1.0
                }
            };
        }
    </script>
</body>
</html>