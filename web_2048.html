<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>2048 Python Web</title>
    <style>
        body { font-family: Arial, sans-serif; background: #faf8ef; color: #776e65; }
        #board { display: grid; grid-template-columns: repeat(4, 80px); grid-gap: 8px; margin: 30px auto; width: 352px; }
        .tile { width: 80px; height: 80px; background: #cdc1b4; display: flex; align-items: center; justify-content: center; font-size: 2em; font-weight: bold; border-radius: 4px; }
        .tile-0 { background: #cdc1b4; color: #cdc1b4; }
        .tile-2 { background: #eee4da; color: #776e65; }
        .tile-4 { background: #ede0c8; color: #776e65; }
        .tile-8 { background: #f2b179; color: #f9f6f2; }
        .tile-16 { background: #f59563; color: #f9f6f2; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; }
        .tile-128 { background: #edcf72; color: #f9f6f2; }
        .tile-256 { background: #edcc61; color: #f9f6f2; }
        .tile-512 { background: #edc850; color: #f9f6f2; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; }
        #controls { text-align: center; margin: 20px; }
        button { margin: 0 5px; padding: 10px 20px; font-size: 1em; }
        #analysis { margin: 20px auto; width: 352px; }
        #log { font-size: 0.9em; color: #888; }
    </style>
</head>
<body>
    <h1 style="text-align:center;">2048 Python Web</h1>
    <div id="controls">
        <button id="btn-play" onclick="setMode('play')">Play</button>
        <button id="btn-heuristic" onclick="setMode('heuristic')">Emulate Heuristic</button>
        <button id="btn-analysis" onclick="setMode('analysis')">Run Analysis</button>
        <select id="heuristicSelect" onchange="updateDescription()">
            <option value="monotonicity">Monotonicity</option>
            <option value="corner">Corner</option>
            <option value="center">Center</option>
            <option value="expectimax">Expectimax</option>
            <option value="opportunistic">Opportunistic</option>
            <option value="mlsim">ML Sim</option>
        </select>
        <label style="margin-left:10px;"><input type="checkbox" id="twophase" onchange="updateDescription()"> Two-Phase</label>
        <button id="btn-reset" onclick="resetGame()">Reset</button>
        <button id="btn-csv" onclick="exportResults('csv')">Export CSV</button>
        <button id="btn-html" onclick="exportResults('html')">Export HTML</button>
    </div>
    <div style="display: flex; justify-content: center; align-items: flex-start;">
        <div style="min-width: 400px;">
            <div id="board"></div>
            <div id="analysis"></div>
            <div id="log"></div>
        </div>
        <div id="sidepane" style="margin-left: 32px; width: 340px; background: #f7f7f7; border-radius: 8px; box-shadow: 0 2px 8px #ccc; min-height: 400px;">
            <div style="display: flex; border-bottom: 1px solid #ddd;">
                <button id="tab-desc" onclick="showTab('desc')" style="flex:1; padding:10px; border:none; background:#eee; font-weight:bold; transition: font-weight 0.2s;">Description</button>
                <button id="tab-stats" onclick="showTab('stats')" style="flex:1; padding:10px; border:none; background:#f7f7f7; font-weight:normal; transition: font-weight 0.2s;">Statistics</button>
            </div>
            <div id="tab-content-desc" style="padding: 16px;">
                <b>Mode:</b> <span id="desc-mode">Play</span><br><br>
                <b>Heuristic:</b> <span id="desc-heuristic">N/A</span><br><br>
                <div id="desc-details">Use arrow keys or WASD to play manually. Select a mode above.</div>
            </div>
            <div id="tab-content-stats" style="display:none; padding: 16px;">
                <div id="stats-content">No statistics yet.</div>
            </div>
        </div>
    </div>
    <script>
        // --- Minimal 2048 logic in JS for browser play ---
        let board, score, mode = 'play', interval = null;
        function emptyBoard() {
            board = Array.from({length:4},()=>Array(4).fill(0));
            score = 0;
            addTile(); addTile();
        }
        function addTile() {
            let empty = [];
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) if(board[i][j]===0) empty.push([i,j]);
            if(empty.length===0) return;
            let [i,j] = empty[Math.floor(Math.random()*empty.length)];
            board[i][j] = Math.random()<0.1?4:2;
        }
        function drawBoard() {
            let html = '';
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) {
                let v = board[i][j];
                html += `<div class="tile tile-${v}">${v? v : ''}</div>`;
            }
            document.getElementById('board').innerHTML = html;
            document.getElementById('log').innerText = 'Score: ' + score;
        }
        function move(dir) {
            let moved = false;
            let old = board.map(r=>r.slice());
            if(dir==='left'||dir==='right') {
                for(let n=0;n<4;n++) {
                    let arr = board[n].slice();
                    if(dir==='right') arr = arr.reverse();
                    let filtered = arr.filter(x=>x);
                    for(let i=0;i<filtered.length-1;i++) if(filtered[i]===filtered[i+1]) { filtered[i]*=2; score+=filtered[i]; filtered[i+1]=0; }
                    filtered = filtered.filter(x=>x);
                    while(filtered.length<4) filtered.push(0);
                    if(dir==='right') filtered = filtered.reverse();
                    board[n] = filtered;
                }
            } else if(dir==='up'||dir==='down') {
                // Transpose, operate as left/right, then transpose back
                let t = [0,1,2,3].map(i=>[board[0][i],board[1][i],board[2][i],board[3][i]]);
                for(let n=0;n<4;n++) {
                    let arr = t[n].slice();
                    if(dir==='down') arr = arr.reverse();
                    let filtered = arr.filter(x=>x);
                    for(let i=0;i<filtered.length-1;i++) if(filtered[i]===filtered[i+1]) { filtered[i]*=2; score+=filtered[i]; filtered[i+1]=0; }
                    filtered = filtered.filter(x=>x);
                    while(filtered.length<4) filtered.push(0);
                    if(dir==='down') filtered = filtered.reverse();
                    t[n] = filtered;
                }
                // Transpose back
                for(let i=0;i<4;i++) for(let j=0;j<4;j++) board[i][j]=t[j][i];
            }
            moved = JSON.stringify(old)!==JSON.stringify(board);
            if(moved) addTile();
            drawBoard();
            if(isGameOver()) document.getElementById('log').innerText += ' | Game Over!';
            return moved;
        }
        function isGameOver() {
            for(let i=0;i<4;i++) for(let j=0;j<4;j++) if(board[i][j]===0) return false;
            for(let i=0;i<4;i++) for(let j=0;j<3;j++) if(board[i][j]===board[i][j+1]) return false;
            for(let j=0;j<4;j++) for(let i=0;i<3;i++) if(board[i][j]===board[i+1][j]) return false;
            return true;
        }
        // Fix: Only attach one keydown event, and always draw board after mode change
        let keyHandler = function(e) {
            if(mode!=='play') return;
            let key = e.key.toLowerCase();
            if(['arrowup','arrowdown','arrowleft','arrowright','w','a','s','d'].includes(key)) {
                e.preventDefault();
                if(key==='arrowup'||key==='w') move('up');
                if(key==='arrowdown'||key==='s') move('down');
                if(key==='arrowleft'||key==='a') move('left');
                if(key==='arrowright'||key==='d') move('right');
            }
        };
        window.removeEventListener('keydown', keyHandler); // Remove if already attached
        window.addEventListener('keydown', keyHandler);
        // --- Tab switching with highlight ---
        function showTab(tab) {
            document.getElementById('tab-content-desc').style.display = (tab==='desc') ? '' : 'none';
            document.getElementById('tab-content-stats').style.display = (tab==='stats') ? '' : 'none';
            document.getElementById('tab-desc').style.background = (tab==='desc') ? '#eee' : '#f7f7f7';
            document.getElementById('tab-stats').style.background = (tab==='stats') ? '#eee' : '#f7f7f7';
            document.getElementById('tab-desc').style.fontWeight = (tab==='desc') ? 'bold' : 'normal';
            document.getElementById('tab-stats').style.fontWeight = (tab==='stats') ? 'bold' : 'normal';
        }
        // --- Heuristic emulation mode ---
        function startHeuristicEmulation() {
            clearInterval(interval);
            interval = setInterval(()=>{
                if(mode!=='heuristic') { clearInterval(interval); return; }
                let heur = document.getElementById('heuristicSelect').value;
                let twophase = document.getElementById('twophase').checked;
                let move;
                if(heur==="mlsim") move = pickMLSimMove();
                else if(twophase) move = pickTwoPhaseMove(heur);
                else move = pickHeuristicMove(heur);
                if(move) moveBoard(move);
                drawBoard();
                if(isGameOver()) {
                    clearInterval(interval);
                    document.getElementById('log').innerText += ' | Game Over!';
                }
            }, 300);
        }
        // --- Analysis mode ---
        function runAnalysis() {
            let results = [];
            let runs = 20;
            let heur = document.getElementById('heuristicSelect').value;
            let twophase = document.getElementById('twophase').checked;
            let allStats = [];
            let runIdx = 0;
            let paramSummary = `<div style='margin-bottom:8px;'><b>Parameters:</b> Heuristic: <b>${heur}</b> | Two-Phase: <b>${twophase?"On":"Off"}</b></div>`;
            setControlsDisabled(true);
            function updateProgressBar() {
                let percent = Math.floor(100 * runIdx / runs);
                let bar = `<div style='width:100%;background:#eee;height:18px;border-radius:8px;overflow:hidden;margin-bottom:8px;'><div id='progress-inner' style='width:${percent}%;background:#f2b179;height:100%;transition:width 0.2s;'></div></div>`;
                return bar;
            }
            function doRun() {
                emptyBoard();
                drawBoard(); // Ensure board updates for each run
                let steps = 0;
                function doStep() {
                    let move;
                    if(heur==="mlsim") move = pickMLSimMove();
                    else if(twophase) move = pickTwoPhaseMove(heur);
                    else move = pickHeuristicMove(heur);
                    if(move && !isGameOver() && steps<1000) {
                        moveBoard(move);
                        drawBoard(); // Ensure board updates for each step
                        steps++;
                        setTimeout(doStep, 0);
                    } else {
                        let maxTile = Math.max(...board.flat());
                        allStats.push({maxTile, score});
                        results.push(maxTile);
                        runIdx++;
                        document.getElementById('analysis').innerHTML = paramSummary + updateProgressBar() + `<i>Running analysis... (${runIdx}/${runs})</i>`;
                        if(runIdx < runs) {
                            setTimeout(doRun, 0);
                        } else {
                            let avg = results.reduce((a,b)=>a+b,0)/results.length;
                            let html = paramSummary + `<b>Analysis for ${heur}${twophase?" (Two-Phase)":""}:</b><br>Runs: ${runs}<br>Average max tile: ${avg.toFixed(2)}<br>Distribution: <br>`;
                            let dist = {};
                            for(let v of results) dist[v] = (dist[v]||0)+1;
                            for(let k of Object.keys(dist).sort((a,b)=>a-b)) html += `${k}: ${dist[k]}<br>`;
                            html += `<canvas id='distChart' width='300' height='120'></canvas>`;
                            document.getElementById('analysis').innerHTML = html;
                            updateStats(html);
                            drawDistChart(dist);
                            window._lastResults = {heur, twophase, runs, results, allStats, dist, avg};
                            drawBoard();
                            setControlsDisabled(false);
                        }
                    }
                }
                setTimeout(doStep, 0); // Schedule step to allow UI update
            }
            document.getElementById('analysis').innerHTML = paramSummary + updateProgressBar() + '<i>Running analysis...</i>';
            runIdx = 0;
            setTimeout(doRun, 0); // Schedule first run to allow UI update
        }
        // --- Mode switching ---
        function setMode(m) {
            mode = m;
            clearInterval(interval);
            document.getElementById('analysis').innerHTML = '';
            if(mode==='heuristic') {
                startHeuristicEmulation();
            }
            if(mode==='analysis') {
                runAnalysis();
            }
            drawBoard();
            updateDescription();
            if(mode!=='analysis') updateStats('No statistics yet.');
        }
        // --- Update description pane ---
        function updateDescription() {
            let modeMap = {play:'Manual Play', heuristic:'Heuristic Emulation', analysis:'Analysis'};
            let heurMap = {
                monotonicity: 'Monotonicity: Favors boards where rows/columns are strictly increasing or decreasing.',
                corner: 'Corner: Tries to keep the largest tile in a corner.',
                center: 'Center: Favors moves toward the center.',
                expectimax: 'Expectimax: Looks ahead using expected value.',
                opportunistic: 'Opportunistic: Combines tiles whenever possible.',
                mlsim: 'ML Sim: Weighted feature-based move selection.'
            };
            let twophase = document.getElementById('twophase').checked;
            let heur = document.getElementById('heuristicSelect').value;
            let heurDesc = (twophase? 'Two-Phase '+heur : heur);
            document.getElementById('desc-mode').innerText = modeMap[mode] || mode;
            document.getElementById('desc-heuristic').innerText = (mode==='heuristic'||mode==='analysis') ? heurDesc : 'N/A';
            document.getElementById('desc-details').innerText = (mode==='play') ?
                'Use arrow keys or WASD to play manually.' :
                (twophase? 'Two-phase: monotonicity, then selected heuristic.' : (heurMap[heur] || ''));
        }
        // --- Init ---
        function updateControls() {
            // For future: enable/disable controls if needed
        }
        emptyBoard(); drawBoard();
        document.getElementById('heuristicSelect').addEventListener('change', updateDescription);
        document.getElementById('twophase').addEventListener('change', updateDescription);
        // Initial tab and desc
        showTab('desc');
        updateDescription();
        function setControlsDisabled(disabled) {
            document.getElementById('btn-play').disabled = disabled;
            document.getElementById('btn-heuristic').disabled = disabled;
            document.getElementById('btn-analysis').disabled = disabled;
            document.getElementById('heuristicSelect').disabled = disabled;
            document.getElementById('twophase').disabled = disabled;
            document.getElementById('btn-reset').disabled = disabled;
            document.getElementById('btn-csv').disabled = disabled;
            document.getElementById('btn-html').disabled = disabled;
        }
    </script>
</body>
</html>
